import React, { useEffect, useRef } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { MapPin, ExternalLink } from 'lucide-react';
import { EscapeRoomLocation } from '@/lib/types';

interface LocationMapProps {
    locations: EscapeRoomLocation[];
    height?: number;
    showControls?: boolean;
}

declare global {
    interface Window {
        naver: any;
    }
}

const LocationMap: React.FC<LocationMapProps> = ({
    locations,
    height = 300,
    showControls = true
}) => {
    const mapRef = useRef<HTMLDivElement>(null);
    const mapInstanceRef = useRef<any>(null);

    useEffect(() => {
        // ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÎåÄÍ∏∞
        if (!window.naver || !window.naver.maps) {
            console.warn('Naver Maps API not loaded');
            return;
        }

        if (!mapRef.current || locations.length === 0) {
            return;
        }

        // Ï≤´ Î≤àÏß∏ ÏúÑÏπòÎ•º Ï§ëÏã¨ÏúºÎ°ú ÏÑ§Ï†ï
        const centerLocation = locations[0];
        const center = new window.naver.maps.LatLng(
            parseFloat(centerLocation.y), 
            parseFloat(centerLocation.x)
        );

        // ÏßÄÎèÑ ÏÉùÏÑ±
        const map = new window.naver.maps.Map(mapRef.current, {
            center: center,
            zoom: locations.length === 1 ? 16 : 13,
            minZoom: 7,
            maxZoom: 21,
            zoomControl: showControls,
            zoomControlOptions: {
                position: window.naver.maps.Position.TOP_RIGHT
            },
            scaleControl: showControls,
            logoControl: true,
            mapDataControl: showControls,
            mapTypeControl: showControls && locations.length > 1,
            // ÏßÄÎèÑ ÏÉÅÌò∏ÏûëÏö© ÏÑ§Ï†ï
            draggable: true,
            pinchZoom: true,
            scrollWheel: true,
            keyboardShortcuts: true,
            disableDoubleTapZoom: false,
            disableDoubleClickZoom: false,
            disableTwoFingerTapZoom: false
        });

        // ÎßàÏª§Îì§ Ï∂îÍ∞Ä
        const markers: any[] = [];
        const infoWindows: any[] = [];

        locations.forEach((location, index) => {
            const position = new window.naver.maps.LatLng(
                parseFloat(location.y),
                parseFloat(location.x)
            );

            // ÎßàÏª§ ÏÉùÏÑ±
            const marker = new window.naver.maps.Marker({
                position: position,
                map: map,
                title: location.name,
                icon: {
                    content: `
                        <div style="
                            background: #3b82f6; 
                            color: white; 
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 12px; 
                            font-weight: bold;
                            border: 2px solid white;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                            white-space: nowrap;
                        ">
                            ${index + 1}
                        </div>
                    `,
                    size: new window.naver.maps.Size(40, 40),
                    anchor: new window.naver.maps.Point(20, 40)
                }
            });

            // Ï†ïÎ≥¥Ï∞Ω ÏÉùÏÑ±
            const infoWindow = new window.naver.maps.InfoWindow({
                content: `
                    <div style="
                        padding: 12px; 
                        max-width: 250px; 
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        line-height: 1.4;
                    ">
                        <div style="font-weight: bold; margin-bottom: 8px; color: #1f2937;">
                            ${location.name}
                        </div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 6px;">
                            üìç ${location.roadAddress}
                        </div>
                        ${location.phone ? `
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">
                                üìû ${location.phone}
                            </div>
                        ` : ''}
                        <div style="text-align: center;">
                            <button 
                                onclick="window.open('https://map.naver.com/v5/search/${encodeURIComponent(location.name + ' ' + location.roadAddress)}', '_blank')"
                                style="
                                    background: #22c55e; 
                                    color: white; 
                                    border: none; 
                                    padding: 6px 12px; 
                                    border-radius: 4px; 
                                    font-size: 12px; 
                                    cursor: pointer;
                                    margin-right: 4px;
                                "
                            >
                                üó∫Ô∏è ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ
                            </button>
                            <button 
                                onclick="window.open('https://map.naver.com/v5/directions/car?c=${location.x},${location.y},18,0,0,0,dh', '_blank')"
                                style="
                                    background: #3b82f6; 
                                    color: white; 
                                    border: none; 
                                    padding: 6px 12px; 
                                    border-radius: 4px; 
                                    font-size: 12px; 
                                    cursor: pointer;
                                "
                            >
                                üöó Í∏∏Ï∞æÍ∏∞
                            </button>
                        </div>
                    </div>
                `,
                borderWidth: 0,
                backgroundColor: 'transparent'
            });

            // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            window.naver.maps.Event.addListener(marker, 'click', () => {
                // Îã§Î•∏ Ï†ïÎ≥¥Ï∞ΩÎì§ Îã´Í∏∞
                infoWindows.forEach(iw => iw.close());
                // ÌòÑÏû¨ Ï†ïÎ≥¥Ï∞Ω Ïó¥Í∏∞
                infoWindow.open(map, marker);
            });

            markers.push(marker);
            infoWindows.push(infoWindow);
        });

        // Ïó¨Îü¨ ÏúÑÏπòÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ Î™®Îì† ÎßàÏª§Í∞Ä Î≥¥Ïù¥ÎèÑÎ°ù ÏßÄÎèÑ Ï°∞Ï†ï
        if (locations.length > 1) {
            const bounds = new window.naver.maps.LatLngBounds();
            locations.forEach(location => {
                bounds.extend(new window.naver.maps.LatLng(
                    parseFloat(location.y),
                    parseFloat(location.x)
                ));
            });
            map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
        }

        mapInstanceRef.current = map;

        // Ï†ïÎ¶¨ Ìï®Ïàò
        return () => {
            markers.forEach(marker => marker.setMap(null));
            infoWindows.forEach(infoWindow => infoWindow.close());
            if (mapInstanceRef.current) {
                mapInstanceRef.current.destroy();
                mapInstanceRef.current = null;
            }
        };
    }, [locations, height, showControls]);

    if (locations.length === 0) {
        return (
            <Card className="border-dashed">
                <CardContent className="text-center py-8">
                    <MapPin className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                    <p className="text-sm text-gray-500">
                        Îì±Î°ùÎêú Îß§Ïû• ÏúÑÏπòÍ∞Ä ÏóÜÏäµÎãàÎã§
                    </p>
                </CardContent>
            </Card>
        );
    }

    return (
        <div className="space-y-3">
            {/* ÏßÄÎèÑ */}
            <div 
                ref={mapRef} 
                style={{ height: `${height}px` }}
                className="w-full rounded-lg border border-gray-200 overflow-hidden"
            />
            
            {/* Îß§Ïû• Î™©Î°ù */}
            <div className="space-y-2">
                {locations.map((location, index) => (
                    <div key={index} className="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                        <div className="flex-shrink-0">
                            <Badge variant="outline" className="bg-blue-100 text-blue-800">
                                {index + 1}
                            </Badge>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium text-gray-900 truncate">
                                {location.name}
                            </p>
                            <p className="text-xs text-gray-500 truncate">
                                {location.roadAddress}
                            </p>
                        </div>
                        <button
                            onClick={() => window.open(
                                `https://map.naver.com/v5/search/${encodeURIComponent(location.name + ' ' + location.roadAddress)}`,
                                '_blank'
                            )}
                            className="flex-shrink-0 p-1 text-gray-400 hover:text-blue-600 transition-colors"
                            title="ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑÏóêÏÑú Î≥¥Í∏∞"
                        >
                            <ExternalLink className="w-4 h-4" />
                        </button>
                    </div>
                ))}
            </div>
            
            {!window.naver && (
                <div className="text-center py-4">
                    <p className="text-xs text-gray-500">
                        ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ APIÎ•º Î°úÎìúÌïòÎäî Ï§ëÏûÖÎãàÎã§...
                    </p>
                </div>
            )}
        </div>
    );
};

export default LocationMap;