# ---------------------------------------
# 1) DuckDNS 플러그인 포함 빌드 단계
# ---------------------------------------
    FROM caddy:builder AS builder

    # DuckDNS 플러그인 설치
    RUN xcaddy build --with github.com/caddy-dns/cloudflare
    
    # ---------------------------------------
    # 2) 최종 실행 단계
    # ---------------------------------------
    FROM caddy:alpine
    
    # 1) 빌드된 Caddy 이진 파일 복사
    COPY --from=builder /usr/bin/caddy /usr/bin/caddy
    
    # 2) Caddyfile 복사 (이미 하고 계신 부분)
    COPY ./docker/caddy/Caddyfile /etc/caddy/Caddyfile
    
    # 3) 인증서 존재 여부를 확인할 Entrypoint 스크립트 복사
    COPY ./docker/caddy/entrypoint.sh /usr/bin/entrypoint.sh
    RUN chmod +x /usr/bin/entrypoint.sh
    
    # 4) 웹 리소스 복사(이미 하고 계신 부분)
    RUN mkdir -p /root/frontend
    WORKDIR /root/frontend
    COPY ./frontend/dist /root/frontend
    
    # 5) Entrypoint 설정
    # ENTRYPOINT ["/usr/bin/entrypoint.sh"]
    
    # 6) 기본 명령 (entrypoint.sh 스크립트 내에서 exec로 Caddy 실행)
    CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
    