# Dev 환경 전용 Nginx 설정

# 1) HTTP → HTTPS 리디렉션
server {
    listen      80;
    server_name dev.crimecat.org;
    return      301 https://$host$request_uri;
}

# 2) HTTPS 서비스 (Dev 콘텐츠 서빙 + API 프록시)
server {
    listen                  443 ssl http2;
    server_name             dev.crimecat.org;

    ssl_certificate         /etc/nginx/certs/cloudflare-cert.pem;
    ssl_certificate_key     /etc/nginx/certs/cloudflare-key.pem;
    ssl_ciphers             HIGH:!aNULL:!MD5;

    root    /usr/share/nginx/html;
    index   index.html;

    # ------------------------------------
    # A) 정적 에셋 전용 블록
    # ------------------------------------
    # /usr/share/nginx/html/assets 이하 파일만
    location /assets/ {
        try_files $uri $uri/ =404;
    }
    # /usr/share/nginx/html/content 이하 파일만
    location /content/ {
        try_files $uri $uri/ =404;
    }
    # 루트에 있는 svg/png/css/js 등도 처리
    location ~* \.(?:css|js|png|jpg|jpeg|gif|svg|ico|json)$ {
        try_files $uri =404;
    }

    # ------------------------------------
    # B) API 프록시
    # ------------------------------------
    location ^~ /api/ {
        proxy_pass           http://host.docker.internal:8080;
        proxy_http_version   1.1;
        proxy_set_header     Host               $host;
        proxy_set_header     X-Real-IP          $remote_addr;
        proxy_set_header     X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header     X-Forwarded-Proto  $scheme;
        proxy_set_header     Origin             $http_origin;
    }

    location ^~ /oauth2/ {
        proxy_pass           http://host.docker.internal:8080;
        proxy_http_version   1.1;
        proxy_set_header     Host               $host;
        proxy_set_header     X-Real-IP          $remote_addr;
        proxy_set_header     X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header     X-Forwarded-Proto  $scheme;
        proxy_set_header     Origin             $http_origin;
    }


    location ^~ /bot/v1/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin  *;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type";
            add_header Access-Control-Max-Age       86400;
            add_header Content-Length               0;
            add_header Content-Type                 "text/plain; charset=UTF-8";
            return 204;
        }

        proxy_pass           http://host.docker.internal:8080;
        proxy_http_version   1.1;
        proxy_set_header     Host               $host;
        proxy_set_header     X-Real-IP          $remote_addr;
        proxy_set_header     X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header     X-Forwarded-Proto  $scheme;
        proxy_set_header     Authorization      $http_authorization;
    }

    # ------------------------------------
    # C) SPA 진입점 (fallback)
    # ------------------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }

    error_page 404 = /index.html;
}
