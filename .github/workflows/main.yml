name: Deploy to Server

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to Appropriate Server
        run: |
          # ë¸Œëœì¹˜ì— ë”°ë¼ ì„œë²„ ì •ë³´ ë° ëª…ë ¹ ê²°ì •
          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            SERVER_USER="cats"
            SERVER_IP="14.36.34.122"
            SERVER_PORT="23"
            ENV_FILE=".env.dev"
            MAKE_CMD="make dev"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            SERVER_USER="sabyun"
            SERVER_IP="14.36.34.122"
            SERVER_PORT="22"
            ENV_FILE=".env.prod"
            MAKE_CMD="make prod"
            echo "ì§€ê¸ˆ ë©”ì¸ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤! sabyun ë¬¸ì˜"
            exit 1
          else
            echo "âŒ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜ì…ë‹ˆë‹¤!"
            exit 1
          fi

          echo "ğŸš€ Deploying to $SERVER_USER@$SERVER_IP (Port: $SERVER_PORT) with $ENV_FILE"

          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP -p $SERVER_PORT << EOF
          echo "âœ… ì„œë²„ì— ì ‘ì† ì™„ë£Œ"

          # Keychain ì ê¸ˆ í•´ì œ (macOS í™˜ê²½ì—ë§Œ í•´ë‹¹)
          echo ${{ secrets.CATS_USER_PASSWORD }} | security -v unlock-keychain ~/Library/Keychains/login.keychain-db

          # crime-cat ë””ë ‰í† ë¦¬ ì´ë™
          cd /Users/$SERVER_USER/dev/crime-cat


          # crime-cat ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
          echo "ğŸ”„ crime-cat ì €ì¥ì†Œ ì—…ë°ì´íŠ¸..."
          git checkout \$(git symbolic-ref --short HEAD) || git checkout -b \$(git symbolic-ref --short HEAD) origin/\$(git symbolic-ref --short HEAD)
          git pull origin \$(git symbolic-ref --short HEAD)

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì ìš©
          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì ìš© ($ENV_FILE)"
          cp config/$ENV_FILE .env

          # ë„ì»¤ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          echo "ğŸ› ï¸ ë„ì»¤ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          make down
          $MAKE_CMD

          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF
