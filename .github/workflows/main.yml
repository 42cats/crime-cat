name: Deploy to Dev Server

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true  # ì„œë¸Œëª¨ë“ˆë„ í•¨ê»˜ ì²´í¬ì•„ì›ƒ

      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to Remote Server
        run: |
          ssh -o StrictHostKeyChecking=no cats@14.36.34.122 -p 23 << 'EOF'
          echo "âœ… ì„œë²„ì— ì ‘ì† ì™„ë£Œ"

          # crime-cat ë””ë ‰í† ë¦¬ ì´ë™
          cd /Users/cats/dev/crime-cat

          # ì„œë¸Œëª¨ë“ˆ(config) ë¨¼ì € ì—…ë°ì´íŠ¸
          echo "ğŸ”„ ì„œë¸Œëª¨ë“ˆ ì—…ë°ì´íŠ¸..."
          git submodule update --init --recursive

          # crime-cat ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
          echo "ğŸ”„ crime-cat ì €ì¥ì†Œ ì—…ë°ì´íŠ¸..."
          git checkout dev || git checkout -b dev origin/dev
          git pull origin dev

          # ë„ì»¤ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          echo "ğŸ› ï¸ ë„ì»¤ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          make down
          make up

          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF
